// Copyright Â© 2024 Michael Thompson
// SPDX-License-Identifier: GPL-2.0-or-later

package vectordata

import "testing"

// Unit tests for paths pulled into segments from segments and routes

func Test_segmentPathsFromReferencesToMainRoute(T *testing.T) {
	sourceText := `(layers
		(layer l1
			(menuitem "test")
			(features roads)
		)
	)
	(feature roads
		(features mainRoad glancingRoad)
	)

	(route mainRoad
		(segment seg1
			(path one
				30.350075 -83.507595
				30.350177 -83.507918
				30.351014 -83.513659
				30.351541 -83.517636
			)
			(path two
				30.351541 -83.517636
				30.351709 -83.519064
				30.351815 -83.519952
				30.351830 -83.520140
				30.351842 -83.520299
			)
		)
		(segment seg2
			(path three
				30.351842 -83.520299
				30.351850 -83.520426
				30.351861 -83.520554
				30.351870 -83.520668
				30.351879 -83.520762
			)
			(path four
				30.351879 -83.520762
				30.351881 -83.520799
				30.351879 -83.520838
				30.351872 -83.520932
				30.351848 -83.521227
				30.351827 -83.521477
				30.351801 -83.521739
			)
		)
	)

	(route glancingRoad
		(segment sidesegs
			(path path1Spur
				30.351014 -83.513659
				30.351035 -83.513658
				30.351056 -83.513662
				30.351102 -83.513671
			)
			(paths mainRoad)
			(path path4Spur
				30.351801 -83.521739
				30.351774 -83.521975
				30.351746 -83.522218
			)
		)
	)
	`

	vd := prepareAndParseStrings(T, sourceText)
	checkThreadableMapItem(T, vd.mapItems["glancingRoad"],
	miThreadCheck{mitRoute, "glancingRoad", latlongType{30351102, -83513671},
	latlongType{30351746, -83522218}, 0, 0, []latlongRefProto{
	{30351014, -83513659, 0, 0, 0},{30351102, -83513671, 0, 0, 6},
	{30351014, -83513659, 0, 1, 0},{30351541, -83517636, 0, 1, 2},
	{30351541, -83517636, 0, 2, 0},{30351842, -83520299, 0, 2, 8},
	{30351842, -83520299, 0, 3, 0},{30351879, -83520762, 0, 3, 8},
	{30351879, -83520762, 0, 4, 0},{30351801, -83521739, 0, 4, 12},
	{30351801, -83521739, 0, 5, 0},{30351746, -83522218, 0, 5, 4}},
	[]any{
		miThreadCheck{mitSegment, "sidesegs", latlongType{30351102, -83513671},
			latlongType{30351746, -83522218}, 0, 5, []latlongRefProto{
			{30351014, -83513659, 0, 0, 0},{30351102, -83513671, 0, 6, 0},
			{30351014, -83513659, 1, 0, 0},{30351541, -83517636, 1, 2, 0},
			{30351541, -83517636, 2, 0, 0},{30351842, -83520299, 2, 8, 0},
			{30351842, -83520299, 3, 0, 0},{30351879, -83520762, 3, 8, 0},
			{30351879, -83520762, 4, 0, 0},{30351801, -83521739, 4, 12, 0},
			{30351801, -83521739, 5, 0, 0},{30351746, -83522218, 5, 4, 0}},
			[]any{
			miThreadCheck{mitPath, "path1Spur", latlongType{30351014, -83513659},
				latlongType{30351102, -83513671}, 0, 6, []latlongRefProto{
				{30351014, -83513659, 0, 0, 0},{30351102, -83513671, 6, 0, 0}},
				[]any{30351014, -83513659, 30351035, -83513658, 30351056, -83513662,
				30351102, -83513671}},
			miThreadCheck{mitPath, "one:1", latlongType{30351014, -83513659},
				latlongType{30351541, -83517636}, 0, 2, []latlongRefProto{
				{30351014, -83513659, 0, 0, 0},{30351541, -83517636, 2, 0, 0}},
				[]any{30351014, -83513659, 30351541, -83517636}},
			miThreadCheck{mitPath, "two", latlongType{30351541, -83517636},
				latlongType{30351842, -83520299}, 0, 8, []latlongRefProto{
				{30351541, -83517636, 0, 0, 0},{30351842, -83520299, 8, 0, 0}},
				[]any{30351541, -83517636, 30351709, -83519064, 30351815, -83519952,
				30351830, -83520140, 30351842, -83520299}},
			miThreadCheck{mitPath, "three", latlongType{30351842, -83520299},
				latlongType{30351879, -83520762}, 0, 8, []latlongRefProto{
				{30351842, -83520299, 0, 0, 0},{30351879, -83520762, 8, 0, 0}},
				[]any{30351842, -83520299, 30351850, -83520426, 30351861, -83520554,
				30351870, -83520668, 30351879, -83520762}},
			miThreadCheck{mitPath, "four", latlongType{30351879, -83520762},
				latlongType{30351801, -83521739}, 0, 12, []latlongRefProto{
				{30351879, -83520762, 0, 0, 0},{30351801, -83521739, 12, 0, 0}},
				[]any{30351879, -83520762, 30351881, -83520799, 30351879, -83520838,
                                30351872, -83520932, 30351848, -83521227, 30351827, -83521477,
                                30351801, -83521739}},
			miThreadCheck{mitPath, "path4Spur", latlongType{30351801, -83521739},
				latlongType{30351746, -83522218}, 0, 4, []latlongRefProto{
				{30351801, -83521739, 0, 0, 0},{30351746, -83522218, 4, 0, 0}},
				[]any{30351801, -83521739, 30351774, -83521975,
				30351746, -83522218}},
		}},
	}}) 
}


func Test_routeSegmentFromReferencesToMainRoute(T *testing.T) {
	sourceText := `(layers
		(layer l1
			(menuitem "test")
			(features roads)
		)
	)
	(feature roads
		(features mainRoad glancingRoad)
	)

	(route mainRoad
		(segment seg1
			(path one
				30.350075 -83.507595
				30.350177 -83.507918
				30.351014 -83.513659
				30.351541 -83.517636
			)
			(path two
				30.351541 -83.517636
				30.351709 -83.519064
				30.351815 -83.519952
				30.351830 -83.520140
				30.351842 -83.520299
			)
		)
		(segment seg2
			(path three
				30.351842 -83.520299
				30.351850 -83.520426
				30.351861 -83.520554
				30.351870 -83.520668
				30.351879 -83.520762
			)
			(path four
				30.351879 -83.520762
				30.351881 -83.520799
				30.351879 -83.520838
				30.351872 -83.520932
				30.351848 -83.521227
				30.351827 -83.521477
				30.351801 -83.521739
			)
		)
	)

	(segment sideseg1
		(path path1Spur
			30.351014 -83.513659
			30.351035 -83.513658
			30.351056 -83.513662
			30.351102 -83.513671
		)
	)

	(segment sideseg2
		(path path4Spur
			30.351801 -83.521739
			30.351774 -83.521975
			30.351746 -83.522218
		)
	)

	(route glancingRoad
		(segments sideseg1 mainRoad sideseg2)
	)
	`

	vd := prepareAndParseStrings(T, sourceText)
	checkThreadableMapItem(T, vd.mapItems["glancingRoad"],
	miThreadCheck{mitRoute, "glancingRoad", latlongType{30351102, -83513671},
	latlongType{30351746, -83522218}, 0, 3, []latlongRefProto{
	{30351014, -83513659, 0, 0, 0},{30351102, -83513671, 0, 0, 6},
	{30351014, -83513659, 1, 0, 0},{30351541, -83517636, 1, 0, 2},
	{30351541, -83517636, 1, 1, 0},{30351842, -83520299, 1, 1, 8},
	{30351842, -83520299, 2, 0, 0},{30351879, -83520762, 2, 0, 8},
	{30351879, -83520762, 2, 1, 0},{30351801, -83521739, 2, 1, 12},
	{30351801, -83521739, 3, 0, 0},{30351746, -83522218, 3, 0, 4}},
	[]any{
		miThreadCheck{mitSegment, "sideseg1", latlongType{30351014, -83513659},
			latlongType{30351102, -83513671}, 0, 0, []latlongRefProto{
			{30351014, -83513659, 0, 0, 0},{30351102, -83513671, 0, 6, 0}},
			[]any{
			miThreadCheck{mitPath, "path1Spur", latlongType{30351014, -83513659},
				latlongType{30351102, -83513671}, 0, 6, []latlongRefProto{
				{30351014, -83513659, 0, 0, 0},{30351102, -83513671, 6, 0, 0}},
				[]any{30351014, -83513659, 30351035, -83513658, 30351056, -83513662,
				30351102, -83513671}},
		}},
		miThreadCheck{mitSegment, "seg1:1", latlongType{30351014, -83513659},
			latlongType{30351842, -83520299}, 0, 1, []latlongRefProto{
			{30351014, -83513659, 0, 0, 0},{30351541, -83517636, 0, 2, 0},
			{30351541, -83517636, 1, 0, 0},{30351842, -83520299, 1, 8, 0}},
			[]any{
			miThreadCheck{mitPath, "one:1", latlongType{30351014, -83513659},
				latlongType{30351541, -83517636}, 0, 2, []latlongRefProto{
				{30351014, -83513659, 0, 0, 0},{30351541, -83517636, 2, 0, 0}},
				[]any{30351014, -83513659, 30351541, -83517636}},
			miThreadCheck{mitPath, "two", latlongType{30351541, -83517636},
				latlongType{30351842, -83520299}, 0, 8, []latlongRefProto{
				{30351541, -83517636, 0, 0, 0},{30351842, -83520299, 8, 0, 0}},
				[]any{30351541, -83517636, 30351709, -83519064, 30351815, -83519952,
				30351830, -83520140, 30351842, -83520299}},
		}},
		miThreadCheck{mitSegment, "seg2", latlongType{30351842, -83520299},
			latlongType{30351801, -83521739}, 0, 1, []latlongRefProto{
			{30351842, -83520299, 0, 0, 0},{30351879, -83520762, 0, 8, 0},
			{30351879, -83520762, 1, 0, 0},{30351801, -83521739, 1, 12, 0}},
			[]any{
			miThreadCheck{mitPath, "three", latlongType{30351842, -83520299},
				latlongType{30351879, -83520762}, 0, 8, []latlongRefProto{
				{30351842, -83520299, 0, 0, 0},{30351879, -83520762, 8, 0, 0}},
				[]any{30351842, -83520299, 30351850, -83520426, 30351861, -83520554,
				30351870, -83520668, 30351879, -83520762}},
			miThreadCheck{mitPath, "four", latlongType{30351879, -83520762},
				latlongType{30351801, -83521739}, 0, 12, []latlongRefProto{
				{30351879, -83520762, 0, 0, 0},{30351801, -83521739, 12, 0, 0}},
				[]any{30351879, -83520762, 30351881, -83520799, 30351879, -83520838,
                                30351872, -83520932, 30351848, -83521227, 30351827, -83521477,
                                30351801, -83521739}},
		}},
		miThreadCheck{mitSegment, "sideseg2", latlongType{30351801, -83521739},
			latlongType{30351746, -83522218}, 0, 0, []latlongRefProto{
			{30351801, -83521739, 0, 0, 0},{30351746, -83522218, 0, 4, 0}},
			[]any{
			miThreadCheck{mitPath, "path4Spur", latlongType{30351801, -83521739},
				latlongType{30351746, -83522218}, 0, 4, []latlongRefProto{
				{30351801, -83521739, 0, 0, 0},{30351746, -83522218, 4, 0, 0}},
				[]any{30351801, -83521739, 30351774, -83521975,
				30351746, -83522218}},
		}},
	}}) 
}
